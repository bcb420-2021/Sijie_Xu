---
title: "BCB420 A1"
output: html_notebook
---

```{r Setup}

if (!requireNamespace("BiocManager", quietly = TRUE))    
  install.packages("BiocManager")

if (!requireNamespace("GEOmetadb", quietly = TRUE))    
  BiocManager::install("GEOmetadb")

if (!requireNamespace("biomaRt", quietly = TRUE))
  BiocManager::install("biomaRt")

if (!requireNamespace("DBI", quietly = TRUE))
  install.packages("DBI")

if (!requireNamespace("dplyr", quietly = TRUE))
  install.packages("dplyr")

if (!requireNamespace("edgeR", quietly = TRUE))
  install.packages("edgeR")

if (!requireNamespace("ggplot2", quietly = TRUE))
  install.packages("ggplot2")

if (!requireNamespace("tidyr", quietly = TRUE))
  install.packages("tidyr")

library("dplyr")

```

# Data Exploration

## Find data of interest

```{r find GEO}

# Query for interested data set regarding human from 2016 and beyond

findTopic <- function(keyword, skip = FALSE) {
  
  # Get meta data and setup connection
  if(!file.exists('GEOmetadb.sqlite')) GEOmetadb::getSQLiteFile()
  con <- RSQLite::dbConnect(RSQLite::SQLite(),'GEOmetadb.sqlite')
  
  # Form query
  sql <- paste("SELECT DISTINCT gse.title, gse.gse, gpl.title, gse.submission_date",
   "FROM",
   " gse JOIN gse_gpl ON gse_gpl.gse=gse.gse",
   " JOIN gpl ON gse_gpl.gpl=gpl.gpl",
   "WHERE",
   " gse.title LIKE '%",
   keyword,
   "%' AND",
   " gse.submission_date > '2016-01-01' AND",
   " gpl.organism LIKE '%Homo sapiens%' AND",
   " gpl.technology LIKE '%high-throughput seq%' ",
   sep=" ")
  
  rs <- RSQLite::dbGetQuery(con,sql)
  
  if(!skip) return(rs)
}

findTopic(keyword = "microRNA") %>% head() %>% knitr::kable(format = "html")


```

## Download dataset GSE89225

```{r download}

# Identify GEO accession
GEO_accession <- "GSE89225"

# Download File if not exist rds file
if (!file.exists("GEO_data.rds")) {
  
  GEO_dir <- paste0("./", GEO_accession)
  
  #Download file from GEO
  sfiles = GEOquery::getGEOSuppFiles(GEO_accession)
  
  # Extract the tar file with txt
  geo_data <- read.csv(rownames(sfiles)[1])
  
  # Save as rds
  saveRDS(object = GEO_data, file = "GEO_data.rds")
  
  # Delete directory
  unlink("GSE89225", recursive = TRUE, force = TRUE)
  
} else {
  geo_data <- readRDS("GEO_data.rds")
}

colnames(geo_data) <- c("ensembl_gene_id", colnames(geo_data)[-1])

geo_data[1:5,1:5] %>% knitr::kable(format = "html", caption = "GSE89225 Data Overview")

```

# Data Cleaning

## Basic Cleaning 

```{r basic_cleaning}

# Get the data type matrix
samples <- data.frame(lapply(colnames(geo_data)[-1], FUN=function(x){unlist(strsplit(x, split = "_"))}))
colnames(samples) <- colnames(geo_data)[-1]
rownames(samples) <- c("cell_type","sample_type", "patient")
samples <- data.frame(t(samples))

# Check for NAs within the data set
geo_data %>% nrow() - complete.cases(geo_data) %>% sum()

# Check for invalid ensemble_gene_id
row_with_ensembl_gene <- grepl(pattern = "ENSG", x = geo_data$ensembl_gene_id) 
geo_data$ensembl_gene_id[!row_with_ensembl_gene] %>% 
  knitr::kable(type = "html", caption = "Abnormal ensembl gene id")

geo_data <- geo_data[row_with_ensembl_gene,]

# Check for non-reading entries
row_sum <- geo_data[-1] %>% rowSums()
geo_data[which(row_sum == 0),] %>% dim()

# Remove zero reading entires
geo_data <- geo_data[which(row_sum != 0),]

```

## Map data to HGNC

``` {r mapping}

# Create data conversion object
if (!file.exists("ID_conversion.rds")) {

  ensembl <- biomaRt::useMart("ensembl")
  ensembl_haspiens <- biomaRt::useDataset("hsapiens_gene_ensembl", mart=ensembl)
  
  id_conversion <- biomaRt::getBM(attributes = c("ensembl_gene_id","hgnc_symbol"), 
                                  filters = c("ensembl_gene_id"), values = geo_data$ensembl_gene_id, mart = ensembl_haspiens)
  
  saveRDS(id_conversion, "ID_conversion.rds")
  
} else {
  
  id_conversion <- readRDS("ID_conversion.rds")
  
}

# Map the data set to the merge file
geo_data_annot <- merge(id_conversion, geo_data, all.y = TRUE, sort = FALSE)

knitr::kable(geo_data_annot[1:5,1:5], type = "html", caption = "HGNC Mapped Data")

# Inspect lost of data via mapping
ensembl_id_missing_gene <- geo_data_annot$ensembl_gene_id[which(is.na(geo_data_annot$hgnc_symbol))]
length(ensembl_id_missing_gene) / nrow(geo_data_annot)
knitr::kable(ensembl_id_missing_gene[1:10], type = "html", caption = "Missing HGNC Data")

geo_data_annot <- geo_data_annot[which(!is.na(geo_data_annot$hgnc_symbol)),]

```

Since the HGNC symbol missing portion of the data is taking 14% of the total data set (~9000), it is very hard to query through these gene manually. I decided to leave them with the original data set to find out if they were highlighted during the differential expression analysis. If it does shows high differential expression, further investigation is required.

# Data Normalization

```{r pre_normalization}

# Unpivot dataset
geo_data_unpivot <- geo_data[,-1] %>% 
  edgeR::cpm() %>% log2() %>%
  as.data.frame() %>% 
  tidyr::gather(key=sample, value=log_cpm) %>% subset(log_cpm > 0)
  
# Density plot
ggplot2::ggplot(geo_data_unpivot, ggplot2::aes(x=log_cpm, color=sample)) +
  ggplot2::geom_density() + ggplot2::labs(title = "Density by sample before Normalization")

# Boxplot
ggplot2::ggplot(geo_data_unpivot, ggplot2::aes(x=sample, y=log_cpm, color=sample)) + 
  ggplot2::geom_boxplot() + ggplot2::coord_flip() + ggplot2::labs(title = "Boxplot by sample before Normalization") + 
  ggplot2::theme(legend.position="none")

# Bimodal Transformation
geo_data_debimodalized <- abs(geo_data[,-1] - colMeans(geo_data[,-1]))

```
Since 

```{r normalization}

# Create edgeR object with counts
count_matrix <- as.matrix(geo_data_debimodalized)
rownames(count_matrix) <- geo_data$ensembl_gene_id

d = edgeR::DGEList(counts=count_matrix, group=samples$sample_type)

# Calculate normalization factors
normalized_count_matrix <- d %>% edgeR::calcNormFactors() %>% edgeR::cpm()

```

```{r post_normalization_datavis}

# Unpivot dataset
geo_data_normalized_unpivot <- normalized_count_matrix %>% 
  log2() %>% 
  as.data.frame() %>% 
  tidyr::gather(key=sample, value=log_cpm) %>% subset(log_cpm > 0)
  
# Density plot
ggplot2::ggplot(geo_data_normalized_unpivot, ggplot2::aes(x=log_cpm, color=sample)) +
  ggplot2::geom_density() + ggplot2::labs(title = "Density by sample after Normalization")

# Boxplot
ggplot2::ggplot(geo_data_normalized_unpivot, ggplot2::aes(x=sample, y=log_cpm, color=sample)) + 
  ggplot2::geom_boxplot() + ggplot2::coord_flip() + ggplot2::labs(title = "Boxplot by sample after Normalization") + 
  ggplot2::theme(legend.position="none")

```